# Git Hooks - Windows PowerShell ç‰ˆæœ¬

Windows ç³»ç»Ÿä¸‹ä½¿ç”¨ PowerShell è„šæœ¬æ¨¡æ‹Ÿ git-ai åŠŸèƒ½çš„ Git hooksã€‚

## ğŸ“¦ å¿«é€Ÿå®‰è£…

### æ–¹æ³• 1ï¼šPowerShell è„šæœ¬å®‰è£…

```powershell
# åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
.\git-hooks\install-windows.ps1
```

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨å®‰è£…

```powershell
# å¤åˆ¶PowerShellè„šæœ¬åˆ°.git\hooksç›®å½•
Copy-Item .git-hooks\pre-commit.ps1 .git\hooks\pre-commit
Copy-Item .git-hooks\post-commit.ps1 .git\hooks\post-commit

# åœ¨æ¯ä¸ªhookæ–‡ä»¶å¼€å¤´æ·»åŠ shebang
# æ–¹å¼A: ä½¿ç”¨PowerShell Core (æ¨è)
Add-Content -Path .git\hooks\pre-commit -Value "#!/usr/bin/env pwsh" -Encoding UTF8
Add-Content -Path .git\hooks\post-commit -Value "#!/usr/bin/env pwsh" -Encoding UTF8

# æ–¹å¼B: ä½¿ç”¨Windows PowerShell
Add-Content -Path .git\hooks\pre-commit -Value "#!/usr/bin/env powershell" -Encoding UTF8
Add-Content -Path .git\hooks\post-commit -Value "#!/usr/bin/env powershell" -Encoding UTF8
```

### æ–¹æ³• 3ï¼šåˆ›å»ºåŒ…è£…è„šæœ¬ï¼ˆæ¨èç”¨äºå…¼å®¹æ€§ï¼‰

åœ¨ `.git\hooks\` ç›®å½•åˆ›å»ºæ— æ‰©å±•åçš„è„šæœ¬æ–‡ä»¶ï¼š

**pre-commit** (æ— æ‰©å±•å):

```bash
#!/bin/sh
pwsh.exe -NoProfile -ExecutionPolicy Bypass -File "$(dirname "$0")/pre-commit.ps1"
```

**post-commit** (æ— æ‰©å±•å):

```bash
#!/bin/sh
pwsh.exe -NoProfile -ExecutionPolicy Bypass -File "$(dirname "$0")/post-commit.ps1"
```

## âš™ï¸ ç³»ç»Ÿè¦æ±‚

- Windows 10/11
- PowerShell 5.1+ æˆ– PowerShell Core 7+
- Git for Windows

## ğŸ”§ å·¥ä½œåŸç†

### Pre-Commit Hook

æ¯æ¬¡ commit å‰è‡ªåŠ¨æ‰§è¡Œï¼š

1. æ‰«æå˜æ›´çš„æ–‡æœ¬æ–‡ä»¶
2. è®¡ç®— SHA256 å“ˆå¸Œ
3. ä¿å­˜æ–‡ä»¶å¿«ç…§åˆ° `.git\git-ai\working-logs\<commit-sha>\blobs\`
4. åˆ›å»ºæ£€æŸ¥ç‚¹ JSON

### Post-Commit Hook

æ¯æ¬¡ commit åè‡ªåŠ¨æ‰§è¡Œï¼š

1. è¯»å– pre-commit åˆ›å»ºçš„å·¥ä½œæ—¥å¿—
2. è·å–æäº¤æ–‡ä»¶åˆ—è¡¨
3. ç”Ÿæˆå½’å±æ—¥å¿— JSON
4. ä½¿ç”¨`git notes --ref=git-ai`é™„åŠ åˆ° commit

## ğŸ“ æ•°æ®å­˜å‚¨

```
.git\
â”œâ”€â”€ git-ai\
â”‚   â””â”€â”€ working-logs\
â”‚       â””â”€â”€ <commit-sha>\
â”‚           â”œâ”€â”€ checkpoints.json
â”‚           â””â”€â”€ blobs\
â”‚               â””â”€â”€ <file-hash>
â””â”€â”€ refs\
    â””â”€â”€ notes\
        â””â”€â”€ git-ai
```

## ğŸ” æŸ¥çœ‹ç»“æœ

```powershell
# æŸ¥çœ‹æŸä¸ªcommitçš„å½’å±ä¿¡æ¯
git notes --ref=git-ai show <commit-sha>

# æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡commit
git notes --ref=git-ai show HEAD

# æŸ¥çœ‹æäº¤å†å²åŠå½’å±
git log --show-notes=git-ai

# å¯¼å‡ºä¸ºJSONï¼ˆéœ€è¦jqæˆ–å…¶ä»–JSONå·¥å…·ï¼‰
git notes --ref=git-ai show HEAD | ConvertFrom-Json | ConvertTo-Json -Depth 10
```

## ğŸ› æ•…éšœæ’æŸ¥

### Hook æœªæ‰§è¡Œ

```powershell
# æ£€æŸ¥æ‰§è¡Œç­–ç•¥
Get-ExecutionPolicy

# å¦‚æœæ˜¯Restrictedï¼Œéœ€è¦ä¿®æ”¹
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# æˆ–è€…åœ¨hookä¸­ä½¿ç”¨ -ExecutionPolicy Bypass
```

### æƒé™é—®é¢˜

```powershell
# ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡ŒPowerShell
# æˆ–ä½¿ç”¨ -ExecutionPolicy Bypass å‚æ•°
```

### ç¼–ç é—®é¢˜

```powershell
# ç¡®ä¿ä½¿ç”¨UTF-8ç¼–ç ä¿å­˜è„šæœ¬
Get-Content .git\hooks\pre-commit | Out-File -Encoding UTF8 .git\hooks\pre-commit
```

## ğŸ¯ è‡ªå®šä¹‰é…ç½®

### æ·»åŠ  AI æ£€æµ‹é€»è¾‘

ç¼–è¾‘`pre-commit.ps1`ï¼Œåœ¨ä¿å­˜å¿«ç…§åæ·»åŠ  AI æ£€æµ‹ï¼š

```powershell
# ç¤ºä¾‹ï¼šæ£€æŸ¥æ–‡ä»¶æ³¨é‡Š
function Test-AIGenerated {
    param([string]$FilePath)

    $content = Get-Content $FilePath -Raw

    if ($content -match "Generated by Cursor|Generated by Copilot") {
        return $true
    }

    return $false
}

# åœ¨Save-FileSnapshotså‡½æ•°ä¸­ä½¿ç”¨
foreach ($file in $Files) {
    $isAI = Test-AIGenerated -FilePath $file
    # æ ¹æ®ç»“æœè®¾ç½®author_id
}
```

### è¿‡æ»¤ç‰¹å®šæ–‡ä»¶

ä¿®æ”¹`Get-ChangedTextFiles`å‡½æ•°ï¼š

```powershell
# è·³è¿‡lockæ–‡ä»¶å’Œå‹ç¼©æ–‡ä»¶
if ($filePath -match '\.(lock|min\.js|min\.css)$') {
    continue
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

```powershell
# ä½¿ç”¨å¹¶è¡Œå¤„ç†ï¼ˆPowerShell 7+ï¼‰
$entries = $Files | ForEach-Object -Parallel {
    $hash = Get-FileSHA256 -FilePath $_
    # å¤„ç†é€»è¾‘
} -ThrottleLimit 4
```

## ğŸ”„ å¸è½½

```powershell
# åˆ é™¤hooks
Remove-Item .git\hooks\pre-commit -Force
Remove-Item .git\hooks\post-commit -Force
Remove-Item .git\hooks\pre-commit.ps1 -Force -ErrorAction SilentlyContinue
Remove-Item .git\hooks\post-commit.ps1 -Force -ErrorAction SilentlyContinue

# æ¸…ç†æ•°æ®
Remove-Item .git\git-ai -Recurse -Force

# åˆ é™¤git notes
git notes --ref=git-ai remove HEAD
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **PowerShell ç‰ˆæœ¬**ï¼šæ¨èä½¿ç”¨ PowerShell 7+ä»¥è·å¾—æ›´å¥½æ€§èƒ½
2. **è·¯å¾„åˆ†éš”ç¬¦**ï¼šè„šæœ¬ä¼šè‡ªåŠ¨å°† Windows è·¯å¾„(`\`)è½¬æ¢ä¸º Git è·¯å¾„(`/`)
3. **æ‰§è¡Œç­–ç•¥**ï¼šç¡®ä¿ PowerShell æ‰§è¡Œç­–ç•¥å…è®¸è¿è¡Œè„šæœ¬
4. **Git Bash å…¼å®¹æ€§**ï¼šåŒ…è£…è„šæœ¬æ–¹æ³•å¯ç¡®ä¿ä¸ Git Bash å…¼å®¹

## ğŸ’¡ ä½¿ç”¨å»ºè®®

- å¼€å‘ç¯å¢ƒä½¿ç”¨è¿™äº›ç®€åŒ–è„šæœ¬å­¦ä¹ åŸç†
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨å®Œæ•´çš„[git-ai å·¥å…·](https://github.com/acunniffe/git-ai)
- å¯æ ¹æ®å›¢é˜Ÿéœ€æ±‚è‡ªå®šä¹‰ AI æ£€æµ‹é€»è¾‘

## ğŸ”— ç›¸å…³èµ„æº

- [PowerShell æ–‡æ¡£](https://docs.microsoft.com/powershell/)
- [Git Hooks æ–‡æ¡£](https://git-scm.com/docs/githooks)
- [git-ai é¡¹ç›®](https://github.com/acunniffe/git-ai)
